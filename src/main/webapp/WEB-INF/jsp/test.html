<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamic Chart.js Example</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <style>
    /* Style to remove bullet point from list */
    .custom-list-style {
      padding-left: 0;
      list-style-type: none;
    }

    /* Style to space out list items */
    .custom-list-style li {
      margin-bottom: 5px; /* You can adjust the spacing between items */
    }
  </style>

  <div class="container" style="margin-top: 20px">
    <table class="table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Round</th>
          <th>Host Metrics</th>
          <th>Model Metrics</th>
        </tr>
      </thead>
      <tbody id="jsonDataBody">
        <!-- Data will be dynamically added here -->
      </tbody>
    </table>
  </div>

  <body style="margin-top: 20px">
    <div class="container">
      <!-- Tabs for each round -->
      <ul class="nav nav-tabs" id="roundTabs" role="tablist">
        <!-- Tabs will be dynamically added here -->
      </ul>

      <!-- Chart container -->
      <div class="tab-content" id="chartTabsContent">
        <!-- Charts will be dynamically added here -->
      </div>
    </div>

    <script>
      const jsonDataArray = [
        '{"timestamp": 1712206275, "type": "strategy_server_metrics", "round": 1, "hostMetrics": {"cpuUsagePercentage": 5.6, "memoryUsagePercentage": 52.67}, "modelMetrics": {"FRO": 0.032961474180370716, "BAR": 0.123456}}',
        '{"timestamp": 171220627, "type": "strategy_server_metrics", "round": 2, "hostMetrics": {"cpuUsagePercentage": 6.2, "memoryUsagePercentage": 49.21}, "modelMetrics": {"FRO": 0.042961474180370716, "FOO": 0.345678}}',
        '{"timestamp": 171220630, "type": "strategy_server_metrics", "round": 3, "hostMetrics": {"cpuUsagePercentage": 6.2, "memoryUsagePercentage": 49.21}, "modelMetrics": {"FRO": 0.0429614741804362345, "FOO": 0.345908}}',
      ];

      // Group data by round
      const groupedData = {};
      jsonDataArray.forEach((jsonData) => {
        const data = JSON.parse(jsonData);
        const roundNumber = data.round;
        if (!groupedData[roundNumber]) {
          groupedData[roundNumber] = [];
        }
        groupedData[roundNumber].push(data);
      });

      // Add tabs for each round
      const roundTabs = document.getElementById("roundTabs");
      const chartTabsContent = document.getElementById("chartTabsContent");

      Object.keys(groupedData).forEach((roundNumber) => {
        const roundData = groupedData[roundNumber];
        const tabId = `round-${roundNumber}-tab`;
        const paneId = `round-${roundNumber}-pane`;

        // Create tab for the round
        const tab = document.createElement("li");
        tab.classList.add("nav-item");
        tab.innerHTML = `
                <a class="nav-link" id="${tabId}" data-bs-toggle="tab" href="#${paneId}" role="tab" aria-controls="${paneId}" aria-selected="false">Round ${roundNumber}</a>
            `;
        roundTabs.appendChild(tab);

        // Create tab content (the chart)
        const chartPane = document.createElement("div");
        chartPane.classList.add("tab-pane", "fade");
        chartPane.id = paneId;
        chartPane.setAttribute("role", "tabpanel");
        chartPane.setAttribute("aria-labelledby", tabId);

        const chartContainer = document.createElement("div");
        chartContainer.classList.add("chart-container");
        chartPane.appendChild(chartContainer);

        chartTabsContent.appendChild(chartPane);

        // Create and render charts for modelMetrics and hostMetrics
        ["modelMetrics", "hostMetrics"].forEach((metricsType) => {
          const metrics = Object.keys(roundData[0][metricsType]);
          const labels = roundData.map((data) => "Round " + data.round);
          const datasets = metrics.map((metric) => {
            return {
              label: metric,
              backgroundColor: getRandomColor(),
              borderColor: getRandomColor(),
              borderWidth: 1,
              data: roundData.map((data) => data[metricsType][metric] || 0),
            };
          });

          // Add a title for the metric type
          const title = document.createElement("h3");
          title.textContent =
            metricsType === "modelMetrics" ? "Model Metrics" : "Host Metrics";
          chartContainer.appendChild(title);

          // Create canvas for the chart
          const canvas = document.createElement("canvas");
          chartContainer.appendChild(canvas);

          // Configure the chart
          const config = {
            type: "bar",
            data: {
              labels: labels,
              datasets: datasets,
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          };

          // Create and render the chart
          new Chart(canvas, config);
        });
      });

      // Function to generate random colors
      function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }
    </script>

    <script>
      jsonDataArray.forEach((jsonString) => {
        const data = JSON.parse(jsonString);
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${data.type}</td>
                <td>${data.round}</td>
                <td>${createList(data.hostMetrics)}</td>
                <td>${createList(data.modelMetrics)}</td>
            `;
        jsonDataBody.appendChild(row);
      });

      // Function to create an HTML list from a JSON object
      function createList(obj) {
        const list = document.createElement("ul");
        list.classList.add("custom-list-style"); // Add class to remove bullet point
        for (const key in obj) {
          if (Object.hasOwnProperty.call(obj, key)) {
            const listItem = document.createElement("li");
            listItem.innerHTML = `<b>${key}</b>: ${obj[key]}`;
            list.appendChild(listItem);
          }
        }
        return list.outerHTML;
      }
    </script>

    <!-- Add Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
