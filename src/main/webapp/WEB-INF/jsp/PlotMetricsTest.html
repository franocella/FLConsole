<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic Chart.js Example</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Add Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body style="margin-top: 20px">
  <div class="container">
    <!-- Tabs for modelMetrics and hostMetrics -->
    <ul class="nav nav-tabs" id="metricsTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="modelMetrics-tab" data-bs-toggle="tab" data-bs-target="#modelMetrics" type="button" role="tab" aria-controls="modelMetrics" aria-selected="true">Model Metrics</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hostMetrics-tab" data-bs-toggle="tab" data-bs-target="#hostMetrics" type="button" role="tab" aria-controls="hostMetrics" aria-selected="false">Host Metrics</button>
      </li>
    </ul>

    <button class="btn btn-primary mt-3" onclick="addNewData({timestamp: 171220635, type: 'strategy_server_metrics', round: 4, hostMetrics: {cpuUsagePercentage: 7.2, memoryUsagePercentage: 54.21}, modelMetrics: {FRO: 0.0424352345, FOO: 0.3141358, BAR: 0.213346}})">
      Add New Data(TEST)
    </button>

    <!-- Tab panes -->
    <div class="tab-content" id="metricsTabContent">
      <div class="tab-pane fade show active" id="modelMetrics" role="tabpanel" aria-labelledby="modelMetrics-tab">
        <!-- Buttons for each modelMetric -->
        <div id="modelMetricsButtons">
          <!-- Buttons will be added dynamically here -->
        </div>
        <!-- Chart container for modelMetrics -->
        <div id="modelMetricsCharts" class="chart-container">
          <!-- Charts will be added dynamically here -->
        </div>
      </div>
      <div class="tab-pane fade" id="hostMetrics" role="tabpanel" aria-labelledby="hostMetrics-tab">
        <!-- Buttons for each hostMetric -->
        <div id="hostMetricsButtons">
          <!-- Buttons will be added dynamically here -->
        </div>
        <!-- Chart container for hostMetrics -->
        <div id="hostMetricsCharts" class="chart-container">
          <!-- Charts will be added dynamically here -->
        </div>
      </div>
    </div>
  </div>

  


  <script>
    let jsonDataArray = [
      '{"timestamp": 1712206275, "type": "strategy_server_metrics", "round": 1, "hostMetrics": {"cpuUsagePercentage": 5.6, "memoryUsagePercentage": 52.67}, "modelMetrics": {"FRO": 0.032961474180370716, "BAR": 0.123456, "FOO": 0.234567}}',
      '{"timestamp": 171220627, "type": "strategy_server_metrics", "round": 2, "hostMetrics": {"cpuUsagePercentage": 6.2, "memoryUsagePercentage": 49.21}, "modelMetrics": {"FRO": 0.042961474180370716, "FOO": 0.345678, "BAR": 0.345678}}',
      '{"timestamp": 171220630, "type": "strategy_server_metrics", "round": 3, "hostMetrics": {"cpuUsagePercentage": 6.2, "memoryUsagePercentage": 49.21}, "modelMetrics": {"FRO": 0.0429614741804362345, "FOO": 0.345908, "BAR": 0.123456}}',
    ];

    // Function to generate charts for modelMetrics and hostMetrics
    function generateCharts() {
      const groupedData = {};
      jsonDataArray.forEach((jsonData) => {
        const data = JSON.parse(jsonData);
        const roundNumber = data.round;
        if (!groupedData[roundNumber]) {
          groupedData[roundNumber] = [];
        }
        groupedData[roundNumber].push(data);
      });

      const metricsTypes = ["modelMetrics", "hostMetrics"];
      metricsTypes.forEach(metricsType => {
        const metricsButtonsContainer = metricsType === "modelMetrics" ? document.getElementById("modelMetricsButtons") : document.getElementById("hostMetricsButtons");
        const metricsChartsContainer = metricsType === "modelMetrics" ? document.getElementById("modelMetricsCharts") : document.getElementById("hostMetricsCharts");

        const allMetrics = {};
        Object.values(groupedData).forEach(roundData => {
          roundData.forEach(item => {
            Object.keys(item[metricsType]).forEach(metric => {
              allMetrics[metric] = true;
            });
          });
        });
      });
      
      // Render charts for each metric by default
      Object.keys(groupedData[1][0].modelMetrics).forEach(metric => {
        renderChart(metric, "modelMetrics", groupedData);
      });

      Object.keys(groupedData[1][0].hostMetrics).forEach(metric => {
        renderChart(metric, "hostMetrics", groupedData);
      });
    }

    // Render chart for the selected metric and metricsType
    function renderChart(metric, metricsType, groupedData) {
      const metricsChartsContainer = metricsType === "modelMetrics" ? document.getElementById("modelMetricsCharts") : document.getElementById("hostMetricsCharts");
      const data = [];
      const labels = [];
      Object.values(groupedData).forEach((roundData) => {
        roundData.forEach((item) => {
          data.push(item[metricsType][metric]);
          labels.push("Round " + item.round);
        });
      });

      // Remove existing chart if any
      const existingChart = metricsChartsContainer.querySelector(`#${metricsType}-${metric}-chart`);
      if (existingChart) {
        existingChart.remove();
      }

      // Create canvas for the chart
      const canvas = document.createElement("canvas");
      canvas.id = `${metricsType}-${metric}-chart`;
      metricsChartsContainer.appendChild(canvas);

      // Configure the chart
      new Chart(canvas, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: metric,
            data: data,
            borderColor: getRandomColor(),
            fill: false
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Function to add new data received as a message
    function addNewData(newData) {
      jsonDataArray.push(JSON.stringify(newData));
      generateCharts();
    }

    // Function to generate random colors
    function getRandomColor() {
      const letters = "0123456789ABCDEF";
      let color = "#";
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    // Call generateCharts function once the DOM is loaded
    document.addEventListener("DOMContentLoaded", () => {
      generateCharts();
    });
  </script>

  <!-- Add Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
