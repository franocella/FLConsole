<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic Chart.js Example</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Add Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body style="margin-top: 20px">
  <div class="container">
    <!-- Tabs for modelMetrics and hostMetrics -->
    <ul class="nav nav-tabs" id="metricsTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="modelMetrics-tab" data-bs-toggle="tab" data-bs-target="#modelMetrics" type="button" role="tab" aria-controls="modelMetrics" aria-selected="true">Model Metrics</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hostMetrics-tab" data-bs-toggle="tab" data-bs-target="#hostMetrics" type="button" role="tab" aria-controls="hostMetrics" aria-selected="false">Host Metrics</button>
      </li>
    </ul>

    <button class="btn btn-primary mt-3" onclick="addNewData({timestamp: 171220635, type: 'strategy_server_metrics', round: 4, hostMetrics: {cpuUsagePercentage: 7.2, memoryUsagePercentage: 54.21}, modelMetrics: {FRO: 0.0424352345, FOO: 0.3141358, BAR: 0.213346}})">
      Add New Data(TEST)
    </button>

    <div class="container" style="margin-top: 20px">
      <table class="table">
        <thead>
          <tr>
            <th>Round</th>
            <th>Host Metrics</th>
            <th>Model Metrics</th>
          </tr>
        </thead>
        <tbody id="jsonDataBody">
          <!-- Data will be dynamically added here -->
        </tbody>
      </table>
    </div>


    <button onclick="openConfigModal('6613f8b7aed2e52b006dea10')">Mostra Configurazione</button>

    <div id="config-modal" class="myAlert" style="display: none;">
      <div class="myAlertBody" style="padding-left:100px; padding-right:100px;">
        <h3 style="margin-bottom: 25px;">Configurazione</h3>
        <table class="table" id="config-table">
          <tbody>
          <tr>
            <th>ID:</th>
            <td id="config-id-modal"></td>
          </tr>
          <tr>
            <th>Conf. Name:</th>
            <td id="config-name-modal"></td>
          </tr>
          <tr>
            <th>Algorithm:</th>
            <td id="AlgorithmModal"></td>
          </tr>
          <tr>
            <th>Code Language:</th>
            <td id="codeLanguage"></td>
          </tr>
          <tr>
            <th>Client selection strategy:</th>
            <td id="ClientStrategyModal"></td>
          </tr>
          <tr>
            <th>Client selection ratio:</th>
            <td id="ClientSelectionRatio"></td>
          </tr>
          <tr>
            <th>Min. number of clients:</th>
            <td id="MinNumberOfClients"></td>
          </tr>
          <tr>
            <th>Stop condition:</th>
            <td id="StopConditionModal"></td>
          </tr>
          <tr>
            <th>Max. number of rounds:</th>
            <td id="MaxNumRounds"></td>
          </tr>
          <tr>
            <th>Stop condition threshold:</th>
            <td id="StopThreshold"></td>
          </tr>
          <tr>
            <th>Target Feature:</th>
            <td id="targetFeature"></td>
          </tr>
          <tr>
            <th>Lambda Factor:</th>
            <td id="lambdaFactor"></td>
          </tr>
          <tr>
            <th>Number of Features:</th>
            <td id="numFeatures"></td>
          </tr>
          <tr>
            <th>Seed:</th>
            <td id="seed"></td>
          </tr>
          <tr>
            <th>Number of Clusters:</th>
            <td id="numClusters"></td>
          </tr>
          <tr>
            <th>Creation Date:</th>
            <td id="creationDate"></td>
          </tr>
          </tbody>
        </table>
        <div class="text-end mt-5">
          <a onclick="closeModal()" class="btn btn-danger">Chiudi</a>
        </div>
      </div>
    </div>


    <script>
      function createConfigModal() {
        // Check if the modal already exists in the DOM
        let modalExists = document.getElementById("config-details-modal");
        if (!modalExists) {
          // Create the modal
          const modal = document.createElement("div");
          modal.id = "config-details-modal";
          modal.className = "myAlert";
          modal.style.display = "none";

          const modalBody = document.createElement("div");
          modalBody.className = "myAlertBody";
          modalBody.style.paddingLeft = "100px";
          modalBody.style.paddingRight = "100px";

          const modalTitle = document.createElement("h3");
          modalTitle.textContent = "Configuration";
          modalBody.appendChild(modalTitle);

          const table = document.createElement("table");
          table.className = "table";
          table.id = "config-table-details";

          const tbody = document.createElement("tbody");

          // Define table rows

          // Add the table to the modal body
          table.appendChild(tbody);
          modalBody.appendChild(table);

          const closeButton = document.createElement("a");
          closeButton.textContent = "Close";
          closeButton.className = "btn btn-danger";
          closeButton.addEventListener("click", closeConfigDetailModal);

          const closeDiv = document.createElement("div");
          closeDiv.className = "text-end mt-5";
          closeDiv.appendChild(closeButton);

          modalBody.appendChild(closeDiv);
          modal.appendChild(modalBody);

          // Append the modal to the body of the document
          document.body.appendChild(modal);
        }
      }

      // Function to close the modal
      function closeConfigDetailModal() {
        document.getElementById("config-details-modal").style.display = "none";
      }

      function updateConfigModal(jsonDataString) {
        try {
          // Parse the JSON string
          const jsonData = JSON.parse(jsonDataString);

          createConfigModal();

          // Update the values in the table with the parsed JSON data
          document.getElementById("config-id-modal").innerText = jsonData.id || "";
          document.getElementById("config-name-modal").innerText = jsonData.name || "";
          document.getElementById("AlgorithmModal").innerText = jsonData.algorithm || "";
          document.getElementById("codeLanguage").innerText = jsonData.codeLanguage || "";
          document.getElementById("ClientStrategyModal").innerText = jsonData.clientSelectionStrategy || "";
          document.getElementById("ClientSelectionRatio").innerText = jsonData.clientSelectionRatio || "";
          document.getElementById("MinNumberOfClients").innerText = jsonData.minNumberClients || "";
          document.getElementById("StopConditionModal").innerText = jsonData.stopCondition || "";
          document.getElementById("MaxNumRounds").innerText = jsonData.maxNumberOfRounds || "";
          document.getElementById("StopThreshold").innerText = jsonData.stopConditionThreshold || "";
          document.getElementById("targetFeature").innerText = jsonData.parameters?.targetFeature || "";
          document.getElementById("lambdaFactor").innerText = jsonData.parameters?.lambdaFactor || "";
          document.getElementById("numFeatures").innerText = jsonData.parameters?.numFeatures || "";
          document.getElementById("seed").innerText = jsonData.parameters?.seed || "";
          document.getElementById("numClusters").innerText = jsonData.parameters?.numClusters || "";
          document.getElementById("creationDate").innerText = jsonData.creationDate || "";

          // Show the modal
          document.getElementById("config-details-modal").style.display = "block";
        } catch (error) {
          console.error("Error parsing or updating modal with JSON data:", error);
        }
      }

    </script>







    <script>
      var jsonDataList = [
        {"id":"6613f8b7aed2e52b006dea10","name":"TestConfig2","algorithm":"fcmeans","codeLanguage":"python","clientSelectionStrategy":"probability","clientSelectionRatio":1.0,"minNumberClients":2,"stopCondition":"max_number_rounds","stopConditionThreshold":5.0,"maxNumberOfRounds":5,"parameters":{"targetFeature":"16","lambdaFactor":"2","numFeatures":"16","seed":"10","numClusters":"10"},"creationDate":"2024-04-08T14:01:27.232+00:00"},
        // Aggiungi gli altri JSON alla lista
      ];

      function openConfigModal(configId) {
        // Trova il JSON corrispondente all'ID fornito
        const jsonData = jsonDataList.find(function (item) {
          return item.id === configId;
        });
        if (jsonData) {
          // Popola la tabella con i valori dal JSON trovato
          document.getElementById("config-id-modal").innerText = jsonData.id;
          document.getElementById("config-name-modal").innerText = jsonData.name;
          document.getElementById("AlgorithmModal").innerText = jsonData.algorithm;
          document.getElementById("codeLanguage").innerText = jsonData.codeLanguage;
          document.getElementById("ClientStrategyModal").innerText = jsonData.clientSelectionStrategy;
          document.getElementById("ClientSelectionRatio").innerText = jsonData.clientSelectionRatio;
          document.getElementById("MinNumberOfClients").innerText = jsonData.minNumberClients;
          document.getElementById("StopConditionModal").innerText = jsonData.stopCondition;
          document.getElementById("MaxNumRounds").innerText = jsonData.maxNumberOfRounds;
          document.getElementById("StopThreshold").innerText = jsonData.stopConditionThreshold;
          document.getElementById("targetFeature").innerText = jsonData.parameters.targetFeature;
          document.getElementById("lambdaFactor").innerText = jsonData.parameters.lambdaFactor;
          document.getElementById("numFeatures").innerText = jsonData.parameters.numFeatures;
          document.getElementById("seed").innerText = jsonData.parameters.seed;
          document.getElementById("numClusters").innerText = jsonData.parameters.numClusters;
          document.getElementById("creationDate").innerText = jsonData.creationDate;
          document.getElementById("config-modal").style.display = "block";
        } else {
          console.error("ID non trovato nella lista dei JSON.");
        }
      }

      function closeModal() {
        document.getElementById("config-modal").style.display = "none";
      }

      function adjustColumnWidths() {
        var table = document.getElementById("config-table");
        var maxColumnWidth = 0;

        // Trova la larghezza massima tra tutte le celle della tabella
        for (var i = 0; i < table.rows.length; i++) {
          for (var j = 0; j < table.rows[i].cells.length; j++) {
            var cell = table.rows[i].cells[j];
            var cellWidth = cell.offsetWidth;
            if (cellWidth > maxColumnWidth) {
              maxColumnWidth = cellWidth;
            }
          }
        }

        // Imposta la larghezza massima per tutte le colonne
        for (var i = 0; i < table.rows.length; i++) {
          for (var j = 0; j < table.rows[i].cells.length; j++) {
            table.rows[i].cells[j].style.width = maxColumnWidth + "px";
          }
        }
      }
    </script>


    <!-- Tab panes -->
    <div class="tab-content" id="metricsTabContent">
      <div class="tab-pane fade show active" id="modelMetrics" role="tabpanel" aria-labelledby="modelMetrics-tab">
        <!-- Buttons for each modelMetric -->
        <div id="modelMetricsButtons">
          <!-- Buttons will be added dynamically here -->
        </div>
        <!-- Chart container for modelMetrics -->
        <div id="modelMetricsCharts" class="chart-container">
          <!-- Charts will be added dynamically here -->
        </div>
      </div>
      <div class="tab-pane fade" id="hostMetrics" role="tabpanel" aria-labelledby="hostMetrics-tab">
        <!-- Buttons for each hostMetric -->
        <div id="hostMetricsButtons">
          <!-- Buttons will be added dynamically here -->
        </div>
        <!-- Chart container for hostMetrics -->
        <div id="hostMetricsCharts" class="chart-container">
          <!-- Charts will be added dynamically here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let jsonDataArray = [
      '{"timestamp": 1712206275, "type": "strategy_server_metrics", "round": 1, "hostMetrics": {"cpuUsagePercentage": 5.6, "memoryUsagePercentage": 52.67}, "modelMetrics": {"FRO": 0.032961474180370716, "BAR": 0.123456, "FOO": 0.234567}}',
      '{"timestamp": 171220627, "type": "strategy_server_metrics", "round": 2, "hostMetrics": {"cpuUsagePercentage": 6.2, "memoryUsagePercentage": 49.21}, "modelMetrics": {"FRO": 0.042961474180370716, "FOO": 0.345678, "BAR": 0.345678}}',
      '{"timestamp": 171220630, "type": "strategy_server_metrics", "round": 3, "hostMetrics": {"cpuUsagePercentage": 6.2, "memoryUsagePercentage": 49.21}, "modelMetrics": {"FRO": 0.0429614741804362345, "FOO": 0.345908, "BAR": 0.123456}}',
    ];

    // Function to generate charts for modelMetrics and hostMetrics
    function generateCharts() {
      const groupedData = {};
      jsonDataArray.forEach((jsonData) => {
        const data = JSON.parse(jsonData);
        const roundNumber = data.round;
        if (!groupedData[roundNumber]) {
          groupedData[roundNumber] = [];
        }
        groupedData[roundNumber].push(data);
      });

      const metricsTypes = ["modelMetrics", "hostMetrics"];
      
      
      // Render charts for each metric by default
      Object.keys(groupedData[1][0].modelMetrics).forEach(metric => {
        renderChart(metric, "modelMetrics", groupedData);
      });

      Object.keys(groupedData[1][0].hostMetrics).forEach(metric => {
        renderChart(metric, "hostMetrics", groupedData);
      });

      // Update the table with new data
      updateTable(groupedData);
    }

    // Render chart for the selected metric and metricsType
    function renderChart(metric, metricsType, groupedData) {
      const metricsChartsContainer = metricsType === "modelMetrics" ? document.getElementById("modelMetricsCharts") : document.getElementById("hostMetricsCharts");
      const data = [];
      const labels = [];
      Object.values(groupedData).forEach((roundData) => {
        roundData.forEach((item) => {
          data.push(item[metricsType][metric]);
          labels.push("Round " + item.round);
        });
      });

      // Remove existing chart if any
      const existingChart = metricsChartsContainer.querySelector(`#${metricsType}-${metric}-chart`);
      if (existingChart) {
        existingChart.remove();
      }

      // Create canvas for the chart
      const canvas = document.createElement("canvas");
      canvas.id = `${metricsType}-${metric}-chart`;
      metricsChartsContainer.appendChild(canvas);

      // Configure the chart
      new Chart(canvas, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: metric,
            data: data,
            borderColor: getRandomColor(),
            fill: false
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Function to add new data received as a message
    function addNewData(newData) {
      jsonDataArray.push(JSON.stringify(newData));
      generateCharts();
    }

    // Function to generate random colors
    function getRandomColor() {
      const letters = "0123456789ABCDEF";
      let color = "#";
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    // Call generateCharts function once the DOM is loaded
    document.addEventListener("DOMContentLoaded", () => {
      generateCharts();
    });
    
    // Function to update the table with new data
    function updateTable(groupedData) {
      const jsonDataBody = document.getElementById("jsonDataBody");
      jsonDataBody.innerHTML = ""; // Clear existing data
      
      Object.values(groupedData).forEach(roundData => {
        roundData.forEach(data => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${data.round}</td>
            <td>${createList(data.hostMetrics)}</td>
            <td>${createList(data.modelMetrics)}</td>
          `;
          jsonDataBody.appendChild(row);
        });
      });
    }




    // Function to create an HTML list from a JSON object
    function createList(obj) {
      const list = document.createElement("ul");
      list.classList.add("custom-list-style"); // Add class to remove bullet point
      for (const key in obj) {
        if (Object.hasOwnProperty.call(obj, key)) {
          const listItem = document.createElement("li");
          listItem.innerHTML = `<b>${key}</b>: ${obj[key]}`;
          list.appendChild(listItem);
        }
      }
      return list.outerHTML;
    }

  </script>

  <!-- Add Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



